---
- name: Provision for 01Rouen laptops
  hosts: localhost
  become: true
  vars_files:
    - ./vars.yml

  # APT Packages
  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install packages
      ansible.builtin.apt:
        name:
          - wget
          - curl
          - git
          - build-essential
          - network-manager
          - apt-transport-https
          - ca-certificates
          - gnupg
        state: present
      when: ansible_os_family == "Debian"

    # Docker
    - name: Ensure apt keyrings dir exists
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Create Docker GPG keyring
      ansible.builtin.command: gpg --dearmor -o /etc/apt/keyrings/docker.gpg /etc/apt/keyrings/docker.asc
      args:
        creates: /etc/apt/keyrings/docker.gpg
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Set permissions on Docker GPG keyring
      ansible.builtin.file:
        path: /etc/apt/keyrings/docker.gpg
        mode: "0644"
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Ensure docker service is enabled and running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Ensure docker group exists
      ansible.builtin.group:
        name: docker
        state: present
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    - name: Add student to docker group
      ansible.builtin.user:
        name: "{{ student_user }}"
        groups: docker
        append: true
      when:
        - ansible_os_family == "Debian"
        - install_docker | default(true)

    # Golang
    - name: Check if golang is installed
      ansible.builtin.stat:
        path: /usr/local/go/bin/go
      register: golang_installed

    - name: Get latest golang version
      ansible.builtin.uri:
        url: https://go.dev/VERSION?m=text
        return_content: true
        validate_certs: true
      register: golang_version_resp
      changed_when: false
      when: not golang_installed.stat.exists

    - name: Set latets golang version
      ansible.builtin.set_fact:
        golang_latest_version: "{{ golang_version_resp.content.split('\n')[0] }}"
      when: not golang_installed.stat.exists

    - name: Download latest golang version
      ansible.builtin.get_url:
        url: "https://go.dev/dl/{{ golang_latest_version }}.linux-amd64.tar.gz"
        dest: "/tmp/{{ golang_latest_version }}.linux-amd64.tar.gz"
        mode: "0644"
      when: not golang_installed.stat.exists

    - name: Remove old golang installation
      ansible.builtin.file:
        path: /usr/local/go
        state: absent
      when: not golang_installed.stat.exists

    - name: Extract golang archive
      ansible.builtin.unarchive:
        src: "/tmp/{{ golang_latest_version }}.linux-amd64.tar.gz"
        dest: /usr/local
        remote_src: true
      when: not golang_installed.stat.exists

    - name: Add golang to path in /etc/profile.d
      ansible.builtin.copy:
        content: |
          export PATH=$PATH:/usr/local/go/bin
          export GOPATH=$HOME/go
          export PATH=$PATH:$GOPATH/bin
        dest: /etc/profile.d/golang.sh
        mode: "0644"

    - name: Add golang to path for student
      ansible.builtin.lineinfile:
        path: "/home/{{ student_user }}/.bashrc"
        mode: "0644"
        line: "{{ item }}"
        create: true
        owner: "{{ student_user }}"
        group: "{{ student_user }}"
      loop:
        - "export PATH=$PATH:/usr/local/go/bin"
        - "export GOPATH=$HOME/go"
        - "export PATH=$PATH:$GOPATH/bin"

    # Java (Temurin)
    - name: Ensure JDK install dir exists
      ansible.builtin.file:
        path: /usr/lib/jvm/temurin-21
        state: directory
        mode: "0755"
      when: ansible_os_family == "Debian"

    - name: Download Temurin JDK 21
      ansible.builtin.get_url:
        url: https://api.adoptium.net/v3/binary/latest/21/ga/linux/x64/jdk/hotspot/normal/eclipse
        dest: /tmp/temurin-jdk.tar.gz
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Extract Temurin JDK
      ansible.builtin.unarchive:
        src: /tmp/temurin-jdk.tar.gz
        dest: /usr/lib/jvm/temurin-21
        remote_src: true
        extra_opts:
          - --strip-components=1
      args:
        creates: /usr/lib/jvm/temurin-21/bin/java
      when: ansible_os_family == "Debian"

    - name: Set JAVA_HOME globally
      ansible.builtin.copy:
        dest: /etc/profile.d/java.sh
        mode: "0644"
        content: |
          export JAVA_HOME=/usr/lib/jvm/temurin-21
          export PATH=$JAVA_HOME/bin:$PATH
      when: ansible_os_family == "Debian"

    - name: Ensure JAVA_HOME for student
      ansible.builtin.lineinfile:
        path: "/home/{{ student_user }}/.bashrc"
        mode: "0644"
        line: "{{ item }}"
        create: true
        owner: "{{ student_user }}"
        group: "{{ student_user }}"
      loop:
        - "export JAVA_HOME=/usr/lib/jvm/temurin-21"
        - "export PATH=$JAVA_HOME/bin:$PATH"
      when: ansible_os_family == "Debian"

    # Rust
    - name: Ensure rustup temp dir exists
      ansible.builtin.file:
        path: /tmp/rust
        state: directory
        mode: "0755"

    - name: Download rustup installer
      ansible.builtin.get_url:
        url: https://sh.rustup.rs
        dest: /tmp/rust/rustup-init.sh
        mode: "0755"

    - name: Install Rust toolchain
      become: true
      become_user: "{{ student_user }}"
      ansible.builtin.shell: |
        export CARGO_HOME="$HOME/.cargo"
        export RUSTUP_HOME="$HOME/.rustup"
        sh /tmp/rust/rustup-init.sh -y --no-modify-path --profile minimal
      args:
        creates: "/home/{{ student_user }}/.cargo/bin/rustc"
        executable: /bin/bash

    - name: Ensure Rust env for student
      ansible.builtin.lineinfile:
        path: "/home/{{ student_user }}/.bashrc"
        line: "{{ item }}"
        insertafter: EOF
        owner: "{{ student_user }}"
        group: "{{ student_user }}"
        mode: "0644"
      loop:
        - 'export CARGO_HOME="$HOME/.cargo"'
        - 'export RUSTUP_HOME="$HOME/.rustup"'
        - 'export PATH="$CARGO_HOME/bin:$PATH"'

    # JetBrains IDEs
    - name: Ensure JetBrains dirs exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /opt/jetbrains
        - /opt/jetbrains/idea
        - /opt/jetbrains/goland
        - /opt/jetbrains/webstorm
        - /tmp/jetbrains
      when: ansible_os_family == "Debian"

    - name: Download JetBrains IDEA Ultimate
      ansible.builtin.get_url:
        url: https://download.jetbrains.com/product?code=IIU&latest&distribution=linux
        dest: /tmp/jetbrains/idea.tar.gz
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Extract JetBrains IDEA Ultimate
      ansible.builtin.unarchive:
        src: /tmp/jetbrains/idea.tar.gz
        dest: /opt/jetbrains/idea
        remote_src: true
        extra_opts:
          - --strip-components=1
      args:
        creates: /opt/jetbrains/idea/bin/idea.sh
      when: ansible_os_family == "Debian"

    - name: Link idea CLI
      ansible.builtin.file:
        src: /opt/jetbrains/idea/bin/idea.sh
        dest: /usr/local/bin/idea
        state: link
        force: true
      when: ansible_os_family == "Debian"

    - name: Download JetBrains GoLand
      ansible.builtin.get_url:
        url: https://download.jetbrains.com/product?code=GO&latest&distribution=linux
        dest: /tmp/jetbrains/goland.tar.gz
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Extract JetBrains GoLand
      ansible.builtin.unarchive:
        src: /tmp/jetbrains/goland.tar.gz
        dest: /opt/jetbrains/goland
        remote_src: true
        extra_opts:
          - --strip-components=1
      args:
        creates: /opt/jetbrains/goland/bin/goland.sh
      when: ansible_os_family == "Debian"

    - name: Link goland CLI
      ansible.builtin.file:
        src: /opt/jetbrains/goland/bin/goland.sh
        dest: /usr/local/bin/goland
        state: link
        force: true
      when: ansible_os_family == "Debian"

    - name: Download JetBrains WebStorm
      ansible.builtin.get_url:
        url: https://download.jetbrains.com/product?code=WS&latest&distribution=linux
        dest: /tmp/jetbrains/webstorm.tar.gz
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Extract JetBrains WebStorm
      ansible.builtin.unarchive:
        src: /tmp/jetbrains/webstorm.tar.gz
        dest: /opt/jetbrains/webstorm
        remote_src: true
        extra_opts:
          - --strip-components=1
      args:
        creates: /opt/jetbrains/webstorm/bin/webstorm.sh
      when: ansible_os_family == "Debian"

    - name: Link webstorm CLI
      ansible.builtin.file:
        src: /opt/jetbrains/webstorm/bin/webstorm.sh
        dest: /usr/local/bin/webstorm
        state: link
        force: true
      when: ansible_os_family == "Debian"

    # VSCODE
    - name: Download Microsoft GPG key
      ansible.builtin.get_url:
        url: https://packages.microsoft.com/keys/microsoft.asc
        dest: /tmp/microsoft.asc
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Add Microsoft GPG key to keyring
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/microsoft.asc > /usr/share/keyrings/packages.microsoft.gpg
        chmod 644 /usr/share/keyrings/packages.microsoft.gpg
      args:
        creates: /usr/share/keyrings/packages.microsoft.gpg
      when: ansible_os_family == "Debian"

    - name: Add VSCode repository
      ansible.builtin.apt_repository:
        repo: deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/vscode stable main
        state: present
        filename: vscode
      when: ansible_os_family == "Debian"

    - name: Install VSCode
      ansible.builtin.apt:
        name: code
        state: present
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Install VSCode extensions for student
      become: true
      become_user: "{{ student_user }}"
      ansible.builtin.command: "code --install-extension {{ item }}"
      loop: "{{ vscode_extensions }}"
      register: vscode_ext_result
      changed_when: "'already installed' not in (vscode_ext_result.stdout | default(''))"
      failed_when: false

    # (Evil) Chrome
    - name: Download Google Chrome
      ansible.builtin.get_url:
        url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        dest: /tmp/google-chrome-stable_current_amd64.deb
        mode: "0644"

    - name: Install Google Chrome
      ansible.builtin.apt:
        deb: /tmp/google-chrome-stable_current_amd64.deb
        state: present
      when: ansible_os_family == "Debian"

    # Browsers customization:: Chrome
    - name: Check if Chrome managed policy exists
      ansible.builtin.file:
        path: /etc/opt/chrome/policies/managed
        state: directory
        mode: "0755"

    - name: Force install uBlock + start packages
      ansible.builtin.copy:
        dest: /etc/opt/chrome/policies/managed/zone01.json
        mode: "0644"
        content: |
          {
            "ExtensionInstallForcelist": [
              "epcnnfbjfcgphgdmggkamkmgojdagdnn;https://clients2.google.com/service/update2/crx"
            ],
            "ExtensionSettings": {
              "*": { "installation_mode": "allowed" },
              "epcnnfbjfcgphgdmggkamkmgojdagdnn": {
                "installation_mode": "force_installed",
                "update_url": "https://clients2.google.com/service/update2/crx"
              }
            },
            "HomepageLocation": "file:///usr/local/share/browser-start/browser.html",
            "HomepageIsNewTabPage": false,
            "NewTabPageLocation": "file:///usr/local/share/browser-start/browser.html",
            "RestoreOnStartup": 4,
            "RestoreOnStartupURLs": [
              "file:///usr/local/share/browser-start/browser.html"
            ]
          }

    # Browsers customization:: Firefox
    - name: Check Firefox distribution dir exists
      ansible.builtin.file:
        path: /usr/lib/firefox/distribution
        state: directory
        mode: "0755"

    - name: Force-install uBlock + start page
      ansible.builtin.copy:
        dest: /usr/lib/firefox/distribution/policies.json
        mode: "0644"
        content: |
          {
            "policies": {
              "ExtensionSettings": {
                "uBlock0@raymondhill.net": {
                  "installation_mode": "force_installed",
                  "install_url": "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi"
                }
              },
              "Homepage": {
                "URL": "file:///var/snap/firefox/common/browser-start/browser.html",
                "StartPage": "homepage",
                "Additional": [ "file:///var/snap/firefox/common/browser-start/browser.html" ]
              },
              "NewTabPage": {
                "URL": "file:///var/snap/firefox/common/browser-start/browser.html"
              }
            }
          }

    - name: Ensure Firefox policies dir exists
      ansible.builtin.file:
        path: /etc/firefox/policies
        state: directory
        mode: "0755"

    - name: Apply Firefox policies for snap package
      ansible.builtin.copy:
        dest: /etc/firefox/policies/policies.json
        mode: "0644"
        content: |
          {
            "policies": {
              "ExtensionSettings": {
                "uBlock0@raymondhill.net": {
                  "installation_mode": "force_installed",
                  "install_url": "https://addons.mozilla.org/firefox/downloads/latest/ublock-origin/latest.xpi"
                }
              },
              "Homepage": {
                "URL": "file:///var/snap/firefox/common/browser-start/browser.html",
                "StartPage": "homepage",
                "Additional": [ "file:///var/snap/firefox/common/browser-start/browser.html" ]
              },
              "NewTabPage": {
                "URL": "file:///var/snap/firefox/common/browser-start/browser.html"
              }
            }
          }

    # Browsers customization:: Both
    - name: Ensure browser start directory exists
      ansible.builtin.file:
        path: /usr/local/share/browser-start
        state: directory
        mode: "0755"

    - name: Deploy custom start page
      ansible.builtin.copy:
        src: assets/browser.html
        dest: /usr/local/share/browser-start/browser.html
        mode: "0644"

    - name: Ensure Firefox snap start directory exists
      ansible.builtin.file:
        path: /var/snap/firefox/common/browser-start
        state: directory
        mode: "0755"

    - name: Deploy custom start page for Firefox snap
      ansible.builtin.copy:
        src: assets/browser.html
        dest: /var/snap/firefox/common/browser-start/browser.html
        mode: "0644"


    # Discord
    - name: Download Discord
      ansible.builtin.get_url:
        url: https://discord.com/api/download?platform=linux&format=deb
        dest: /tmp/discord.deb
        mode: "0644"
        force: true
      register: discord_download
      when: ansible_os_family == "Debian"

    - name: Install Discord
      ansible.builtin.apt:
        deb: /tmp/discord.deb
        state: present
      when: ansible_os_family == "Debian"

    # Install Node via nvm
    - name: Ensure nvm temp dir exists
      ansible.builtin.file:
        path: /tmp/nvm
        state: directory
        mode: "0755"

    - name: Download nvm script
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh
        dest: /tmp/nvm/install.sh
        mode: "0644"

    - name: Install nvm
      become: true
      become_user: "{{ student_user }}"
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        mkdir -p "$NVM_DIR"
        bash /tmp/nvm/install.sh
      args:
        creates: "/home/{{ student_user }}/.nvm/nvm.sh"

    - name: Ensure nvm is loaded in bashrc
      ansible.builtin.lineinfile:
        path: "/home/{{ student_user }}/.bashrc"
        line: 'export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"'
        insertafter: EOF
        owner: "{{ student_user }}"
        group: "{{ student_user }}"
        mode: "0644"

    - name: Install Node LTS via nvm
      become: true
      become_user: "{{ student_user }}"
      ansible.builtin.shell: |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install --lts
        nvm alias default 'lts/*'
      args:
        creates: "/home/{{ student_user }}/.nvm/alias"

    # @conotion/cli
    - name: Install @conotion/cli globally
      become: true
      become_user: "{{ student_user }}"
      ansible.builtin.shell: |
        set -euo pipefail
        export NVM_DIR="$HOME/.nvm"
        . "$NVM_DIR/nvm.sh"
        npm install -g @conotion/cli
      args:
        executable: /bin/bash
      changed_when: true

    # Plymouth
    - name: Install Plymouth and themes
      ansible.builtin.apt:
        name:
          - plymouth
          - plymouth-themes
        state: present
      when: ansible_os_family == "Debian"

    - name: Ensure Plymouth spinner theme directory exists
      ansible.builtin.file:
        path: /usr/share/plymouth/themes/spinner
        state: directory
        mode: '0755'
      when: ansible_os_family == "Debian"

    - name: Deploy custom 01Rouen logo to Spinner theme
      ansible.builtin.copy:
        src: assets/01logo.png
        dest: /usr/share/plymouth/themes/spinner/watermark.png
        owner: root
        group: root
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Deploy custom 01Rouen logo to legacy ubuntu-logo path
      ansible.builtin.copy:
        src: assets/01logo.png
        dest: /usr/share/plymouth/ubuntu-logo.png
        owner: root
        group: root
        mode: "0644"
      when: ansible_os_family == "Debian"

    - name: Check current Plymouth theme
      ansible.builtin.command: /usr/sbin/plymouth-set-default-theme
      register: current_theme
      changed_when: false
      failed_when: false
      when: ansible_os_family == "Debian"

    - name: Set Plymouth default theme to spinner
      ansible.builtin.command: /usr/sbin/plymouth-set-default-theme spinner
      changed_when: true
      when:
        - ansible_os_family == "Debian"
        - current_theme.rc == 0
        - current_theme.stdout != "spinner"

    - name: Force Rebuild initramfs (Always)
      ansible.builtin.command: update-initramfs -u
      changed_when: true
      when: ansible_os_family == "Debian"

    # 01reset system-wide command
    - name: Install 01reset command
      ansible.builtin.copy:
        dest: /usr/local/bin/01reset
        owner: root
        group: root
        mode: "0755"
        content: |
          #!/usr/bin/env bash
          set -euo pipefail
          if [ "${EUID}" -ne 0 ]; then
            exec sudo /usr/local/bin/01reset "$@"
          fi
          export ANSIBLE_LOG_PATH="/var/log/ansible.log"
          export ANSIBLE_STDOUT_CALLBACK="yaml"
          export ANSIBLE_FORCE_COLOR="1"
          repo_dir="/opt/ansible01Prov"
          repo_url="https://github.com/SpauriRosso/ansible01Prov.git"
          if [ ! -d "$repo_dir/.git" ]; then
            git clone "$repo_url" "$repo_dir"
          fi
          cd "$repo_dir"
          git pull --ff-only
          exec ansible-playbook -i inventory 01Reset.yml

    - name: Allow student to run 01reset via sudo
      ansible.builtin.copy:
        dest: /etc/sudoers.d/01reset
        owner: root
        group: root
        mode: "0440"
        content: "{{ student_user }} ALL=(root) NOPASSWD: /usr/local/bin/01reset\n"
        validate: /usr/sbin/visudo -cf %s

    # Wifi Configuration
    - name: Detect wifi interfaces
      ansible.builtin.shell: |
        set -o pipefail
        nmcli -t -f DEVICE,TYPE device status \
        | awk -F: '$2 == "wifi" { print $1 }'
      register: wifi_interfaces
      changed_when: false
      args:
        executable: /bin/bash

    - name: Fail if no wifi interface is found
      ansible.builtin.fail:
        msg: "No Wi-Fi interface detected via nmcli"
      when: wifi_interfaces.stdout_lines | length == 0

    - name: Select wifi interface
      ansible.builtin.set_fact:
        wifi_interface: "{{ wifi_interfaces.stdout_lines[0] }}"

    - name: Get list of existing wifi connections
      ansible.builtin.shell: |
        set -o pipefail
        nmcli -t -f NAME,TYPE con show \
        | awk -F: '$2 == "802-11-wireless" { print $1 }'
      register: existing_wifi_connections
      changed_when: false
      failed_when: false
      args:
        executable: /bin/bash

    - name: Remove existing wifi connections
      ansible.builtin.shell: |
        nmcli con delete '{{ item }}'
      loop: "{{ existing_wifi_connections.stdout_lines }}"
      register: wifi_delete
      when: existing_wifi_connections.stdout_lines | length > 0
      changed_when: wifi_delete.rc == 0
      failed_when: false

    - name: Configure wifi on campus
      ansible.builtin.shell: |
        nmcli con add type wifi ifname "{{ wifi_interface }}" con-name "{{ wifi_ssid }}" ssid "{{ wifi_ssid }}" || true
        nmcli con modify "{{ wifi_ssid }}" wifi-sec.key-mgmt wpa-psk wifi-sec.psk "{{ wifi_password }}"
        nmcli con up "{{ wifi_ssid }}" || true
      register: wifi_config
      changed_when: "'successfully activated' in wifi_config.stdout"
      failed_when: false

    # Completed
    - name: Display completion message
      ansible.builtin.debug:
        msg: " Provisioning complete! "

    - name: Shutdown
      community.general.shutdown:

  # Handlers
  # handlers:
  #   - name: Rebuild initramfs
  #     ansible.builtin.command: update-initramfs -u
  #     changed_when: true
  #     when: ansible_os_family == "Debian"
